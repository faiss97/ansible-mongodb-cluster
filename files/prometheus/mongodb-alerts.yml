# =============================================================================
# Prometheus Alerting Rules for MongoDB
# =============================================================================
# Generated by ansible-mongodb-cluster
# Deploy to: /etc/prometheus/rules/mongodb.yml
# =============================================================================

groups:
  - name: mongodb.rules
    interval: 30s
    rules:
      # Instance Health
      - alert: MongoDBDown
        expr: mongodb_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB instance down"
          description: "MongoDB instance {{ $labels.instance }} is down"

      - alert: MongoDBRestarted
        expr: changes(mongodb_instance_uptime_seconds[10m]) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB instance restarted"
          description: "MongoDB instance {{ $labels.instance }} has restarted"

      # Replica Set Alerts
      - alert: MongoDBReplicaSetNoPrimary
        expr: mongodb_rs_members_state{member_state="PRIMARY"} != 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB replica set has no primary"
          description: "MongoDB replica set {{ $labels.rs_nm }} has no primary node"

      - alert: MongoDBReplicaSetMemberUnhealthy
        expr: mongodb_rs_members_health != 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB replica set member unhealthy"
          description: "MongoDB replica set member {{ $labels.member_idx }} is unhealthy"

      - alert: MongoDBReplicationLag
        expr: |
          (mongodb_rs_members_optimeDate{member_state="PRIMARY"} - 
           ignoring(member_state) mongodb_rs_members_optimeDate{member_state="SECONDARY"}) > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB replication lag detected"
          description: "MongoDB replication lag is {{ $value }} seconds on {{ $labels.instance }}"

      - alert: MongoDBReplicationLagCritical
        expr: |
          (mongodb_rs_members_optimeDate{member_state="PRIMARY"} - 
           ignoring(member_state) mongodb_rs_members_optimeDate{member_state="SECONDARY"}) > 120
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB replication lag critical"
          description: "MongoDB replication lag is {{ $value }} seconds on {{ $labels.instance }}"

      # Connection Alerts
      - alert: MongoDBTooManyConnections
        expr: mongodb_ss_connections{conn_type="current"} / mongodb_ss_connections{conn_type="available"} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB too many connections"
          description: "MongoDB connection usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      - alert: MongoDBConnectionsCritical
        expr: mongodb_ss_connections{conn_type="current"} / mongodb_ss_connections{conn_type="available"} > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB connections critical"
          description: "MongoDB connection usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Memory Alerts
      - alert: MongoDBHighMemoryUsage
        expr: mongodb_ss_mem_resident > 0.9 * mongodb_ss_mem_virtual
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB high memory usage"
          description: "MongoDB memory usage is high on {{ $labels.instance }}"

      - alert: MongoDBWiredTigerCacheFull
        expr: |
          mongodb_ss_wt_cache_bytes_currently_in_the_cache / 
          mongodb_ss_wt_cache_maximum_bytes_configured > 0.95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB WiredTiger cache is nearly full"
          description: "WiredTiger cache usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Performance Alerts
      - alert: MongoDBSlowQueries
        expr: rate(mongodb_ss_opcounters{legacy_op_type="query"}[5m]) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB high query rate"
          description: "MongoDB query rate is {{ $value | humanize }}/s on {{ $labels.instance }}"

      - alert: MongoDBHighLatency
        expr: |
          rate(mongodb_ss_opLatencies_latency{op_type="reads"}[5m]) / 
          rate(mongodb_ss_opLatencies_ops{op_type="reads"}[5m]) > 100000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB high read latency"
          description: "MongoDB read latency is high on {{ $labels.instance }}"

      # Cursor Alerts
      - alert: MongoDBCursorsTimeout
        expr: increase(mongodb_ss_metrics_cursor_timedOut[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB cursors timing out"
          description: "{{ $value }} cursors have timed out in the last 5 minutes on {{ $labels.instance }}"

      - alert: MongoDBTooManyCursors
        expr: mongodb_ss_metrics_cursor_open{csr_type="total"} > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB too many open cursors"
          description: "{{ $value }} cursors are open on {{ $labels.instance }}"

      # Storage Alerts
      - alert: MongoDBAsserts
        expr: increase(mongodb_ss_asserts{assert_type=~"regular|warning"}[5m]) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB asserts detected"
          description: "MongoDB {{ $labels.assert_type }} assert on {{ $labels.instance }}"

      - alert: MongoDBAssertsError
        expr: increase(mongodb_ss_asserts{assert_type=~"msg|user"}[5m]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB error asserts detected"
          description: "MongoDB {{ $labels.assert_type }} assert on {{ $labels.instance }}"

  - name: mongodb.recording.rules
    interval: 30s
    rules:
      # Recording rules for dashboard performance
      - record: mongodb:ops_per_second:rate5m
        expr: sum(rate(mongodb_ss_opcounters[5m])) by (instance, legacy_op_type)

      - record: mongodb:connections_usage_percent
        expr: mongodb_ss_connections{conn_type="current"} / mongodb_ss_connections{conn_type="available"} * 100

      - record: mongodb:cache_usage_percent
        expr: mongodb_ss_wt_cache_bytes_currently_in_the_cache / mongodb_ss_wt_cache_maximum_bytes_configured * 100

      - record: mongodb:replication_lag_seconds
        expr: |
          mongodb_rs_members_optimeDate{member_state="PRIMARY"} - 
          ignoring(member_state) group_right() mongodb_rs_members_optimeDate{member_state="SECONDARY"}
