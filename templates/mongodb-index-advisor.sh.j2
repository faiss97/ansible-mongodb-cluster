#!/bin/bash
# =============================================================================
# MongoDB Index Advisor
# =============================================================================
# Analyzes query patterns and suggests index improvements.
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

REPORT_DIR="/opt/mongodb-performance/reports"
REPORT_FILE="${REPORT_DIR}/index-advisor-$(date +%Y%m%d).md"
MONGO_PORT="{{ mongodb_port }}"

{% if mongodb_security_auth_enabled %}
AUTH_OPTS="--username {{ mongodb_admin_user }} --password {{ mongodb_admin_password }} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

mkdir -p "${REPORT_DIR}"

cat > "${REPORT_FILE}" << EOF
# MongoDB Index Advisor Report
Generated: $(date)
Host: $(hostname)

## Summary

EOF

echo "Analyzing indexes..."

# Get all databases
DATABASES=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "db.adminCommand({listDatabases: 1}).databases.filter(d => !['admin','local','config'].includes(d.name)).map(d => d.name).join(' ')" \
    --quiet 2>/dev/null)

for db in ${DATABASES}; do
    echo "Analyzing database: ${db}"
    
    cat >> "${REPORT_FILE}" << EOF

## Database: ${db}

EOF
    
    # Get collections
    COLLECTIONS=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
        --eval "db.getSiblingDB('${db}').getCollectionNames().join(' ')" \
        --quiet 2>/dev/null)
    
    for coll in ${COLLECTIONS}; do
        echo "  Collection: ${coll}"
        
        # Get index stats
        INDEX_STATS=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} --eval "
            var db = db.getSiblingDB('${db}');
            var stats = db.${coll}.aggregate([{\$indexStats: {}}]).toArray();
            JSON.stringify(stats);
        " --quiet 2>/dev/null || echo "[]")
        
        # Get collection stats
        COLL_STATS=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} --eval "
            var db = db.getSiblingDB('${db}');
            var stats = db.${coll}.stats();
            JSON.stringify({
                count: stats.count,
                size: stats.size,
                indexCount: stats.nindexes,
                totalIndexSize: stats.totalIndexSize
            });
        " --quiet 2>/dev/null || echo "{}")
        
        # Analyze slow queries from profiler
        SLOW_QUERIES=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} --eval "
            var db = db.getSiblingDB('${db}');
            var queries = db.system.profile.find({
                ns: '${db}.${coll}',
                millis: {\$gt: 100}
            }).sort({millis: -1}).limit(5).toArray();
            JSON.stringify(queries.map(q => ({
                op: q.op,
                millis: q.millis,
                planSummary: q.planSummary,
                query: q.command?.filter || q.query
            })));
        " --quiet 2>/dev/null || echo "[]")
        
        cat >> "${REPORT_FILE}" << EOF

### Collection: ${coll}

**Statistics:**
\`\`\`json
${COLL_STATS}
\`\`\`

**Index Usage:**
\`\`\`json
${INDEX_STATS}
\`\`\`

**Recent Slow Queries:**
\`\`\`json
${SLOW_QUERIES}
\`\`\`

EOF
        
        # Check for unused indexes
        UNUSED=$(echo "${INDEX_STATS}" | jq -r '.[] | select(.accesses.ops == 0) | .name' 2>/dev/null || echo "")
        if [ -n "${UNUSED}" ]; then
            cat >> "${REPORT_FILE}" << EOF
**⚠️ Potentially Unused Indexes:**
${UNUSED}

EOF
        fi
        
        # Check for COLLSCAN in slow queries
        if echo "${SLOW_QUERIES}" | grep -q "COLLSCAN"; then
            cat >> "${REPORT_FILE}" << EOF
**⚠️ Collection Scans Detected:**
Consider adding indexes for frequently queried fields.

EOF
        fi
    done
done

cat >> "${REPORT_FILE}" << EOF

## Recommendations

1. Remove unused indexes to save disk space and improve write performance
2. Add indexes for fields that appear in COLLSCAN queries
3. Consider compound indexes for multi-field queries
4. Review index key order for range queries

---
*Report generated by MongoDB Index Advisor*
EOF

echo ""
echo "Report saved to: ${REPORT_FILE}"

exit 0
