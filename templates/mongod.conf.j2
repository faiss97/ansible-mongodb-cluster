# =============================================================================
# MongoDB Configuration File
# =============================================================================
# Generated by Ansible - Do not edit manually
# Managed by: ansible-mongodb-cluster role
# Generated on: {{ ansible_date_time.iso8601 }}
# =============================================================================

# -----------------------------------------------------------------------------
# System Log Settings
# -----------------------------------------------------------------------------
systemLog:
  destination: {{ mongodb_log_destination }}
{% if mongodb_log_destination == 'file' %}
  path: {{ mongodb_log_file }}
  logAppend: {{ mongodb_log_append | lower }}
  logRotate: {{ mongodb_log_rotate }}
{% endif %}
  verbosity: {{ mongodb_log_verbosity }}
  timeStampFormat: {{ mongodb_log_timestamp_format }}
{% if mongodb_log_component_verbosity is defined and mongodb_log_component_verbosity | length > 0 %}
  component:
{% for component, settings in mongodb_log_component_verbosity.items() %}
    {{ component }}:
      verbosity: {{ settings.verbosity | default(0) }}
{% endfor %}
{% endif %}

# -----------------------------------------------------------------------------
# Process Management
# -----------------------------------------------------------------------------
processManagement:
  fork: true
  pidFilePath: {{ mongodb_pid_file }}
  timeZoneInfo: /usr/share/zoneinfo

# -----------------------------------------------------------------------------
# Network Settings
# -----------------------------------------------------------------------------
net:
  port: {{ mongodb_port }}
  bindIp: {{ mongodb_bind_ip }}
{% if mongodb_ipv6 %}
  ipv6: true
{% endif %}
  maxIncomingConnections: {{ mongodb_max_connections }}
{% if mongodb_unixdomainsocket_enabled %}
  unixDomainSocket:
    enabled: true
    pathPrefix: {{ mongodb_unixdomainsocket_path }}
{% endif %}
{% if mongodb_net_compression is defined and mongodb_net_compression | length > 0 %}
  compression:
    compressors: {{ mongodb_net_compression | join(',') }}
{% endif %}
{% if mongodb_tls_enabled %}
  tls:
    mode: {{ mongodb_tls_mode }}
    certificateKeyFile: {{ mongodb_tls_certificate_key_file }}
{% if mongodb_tls_ca_file %}
    CAFile: {{ mongodb_tls_ca_file }}
{% endif %}
{% if mongodb_tls_allow_invalid_certificates %}
    allowInvalidCertificates: true
{% endif %}
{% if mongodb_tls_allow_invalid_hostnames %}
    allowInvalidHostnames: true
{% endif %}
{% if mongodb_tls_disable_protocols %}
    disabledProtocols: {{ mongodb_tls_disable_protocols }}
{% endif %}
{% if mongodb_tls_cluster_auth_mode %}
    clusterAuthMode: {{ mongodb_tls_cluster_auth_mode }}
{% endif %}
{% endif %}

# -----------------------------------------------------------------------------
# Storage Settings
# -----------------------------------------------------------------------------
storage:
  dbPath: {{ mongodb_data_directory }}
  journal:
    enabled: {{ mongodb_storage_journal_enabled | lower }}
{% if mongodb_storage_journal_commit_interval_ms is defined %}
    commitIntervalMs: {{ mongodb_storage_journal_commit_interval_ms }}
{% endif %}
  directoryPerDB: {{ mongodb_storage_directory_per_db | lower }}
  engine: {{ mongodb_storage_engine }}
{% if mongodb_storage_engine == 'wiredTiger' %}
  wiredTiger:
    engineConfig:
{% if _mongodb_wiredtiger_cache_final is defined and _mongodb_wiredtiger_cache_final %}
      cacheSizeGB: {{ _mongodb_wiredtiger_cache_final }}
{% endif %}
      journalCompressor: {{ mongodb_wiredtiger_journal_compressor }}
{% if mongodb_wiredtiger_statistics_log_enabled %}
      statisticsLogDelaySecs: 0
{% endif %}
    collectionConfig:
      blockCompressor: {{ mongodb_wiredtiger_collection_block_compressor }}
    indexConfig:
      prefixCompression: {{ mongodb_wiredtiger_index_prefix_compression | lower }}
{% endif %}
{% if mongodb_storage_engine == 'inMemory' and mongodb_inmemory_size_gb %}
  inMemory:
    engineConfig:
      inMemorySizeGB: {{ mongodb_inmemory_size_gb }}
{% endif %}

# -----------------------------------------------------------------------------
# Security Settings
# -----------------------------------------------------------------------------
{% if mongodb_security_auth_enabled %}
security:
  authorization: {{ mongodb_security_authorization }}
{% if mongodb_deployment_mode in ['replicaset', 'sharded'] and _mongodb_keyfile_configured %}
  keyFile: {{ mongodb_keyfile_path }}
{% if mongodb_tls_enabled and mongodb_tls_cluster_auth_mode %}
  clusterAuthMode: {{ mongodb_tls_cluster_auth_mode }}
{% endif %}
{% endif %}
{% if mongodb_authentication_mechanisms is defined and mongodb_authentication_mechanisms | length > 0 %}
  authenticationMechanisms: {{ mongodb_authentication_mechanisms | join(',') }}
{% endif %}
{% if not mongodb_security_javascript_enabled %}
  javascriptEnabled: false
{% endif %}
{% if mongodb_ldap_enabled %}
  ldap:
    servers: {{ mongodb_ldap_servers }}
{% if mongodb_ldap_bind_dn %}
    bind:
      queryUser: {{ mongodb_ldap_bind_dn }}
      queryPassword: {{ mongodb_ldap_bind_password }}
{% endif %}
{% if mongodb_ldap_user_to_dn_mapping %}
    userToDNMapping: {{ mongodb_ldap_user_to_dn_mapping }}
{% endif %}
{% endif %}
{% if mongodb_encryption_enabled and mongodb_encryption_key_file %}
  enableEncryption: true
  encryptionKeyFile: {{ mongodb_encryption_key_file }}
{% endif %}
{% endif %}

# -----------------------------------------------------------------------------
# Operation Profiling
# -----------------------------------------------------------------------------
operationProfiling:
  mode: {{ mongodb_profiling_mode }}
  slowOpThresholdMs: {{ mongodb_profiling_slow_op_threshold_ms }}
{% if mongodb_profiling_slow_op_sample_rate != 1.0 %}
  slowOpSampleRate: {{ mongodb_profiling_slow_op_sample_rate }}
{% endif %}
{% if mongodb_profiling_filter is defined and mongodb_profiling_filter | length > 0 %}
  filter: {{ mongodb_profiling_filter | to_json }}
{% endif %}

# -----------------------------------------------------------------------------
# Replica Set Settings
# -----------------------------------------------------------------------------
{% if mongodb_deployment_mode == 'replicaset' %}
replication:
  replSetName: {{ mongodb_replicaset_name }}
{% if mongodb_oplog_size_mb is defined and mongodb_oplog_size_mb > 0 %}
  oplogSizeMB: {{ mongodb_oplog_size_mb }}
{% endif %}
{% if mongodb_secondary_read_enabled %}
  enableMajorityReadConcern: true
{% endif %}
{% endif %}

# -----------------------------------------------------------------------------
# Sharding Settings (Config Server)
# -----------------------------------------------------------------------------
{% if mongodb_deployment_mode == 'sharded' and mongodb_config_server %}
sharding:
  clusterRole: configsvr
replication:
  replSetName: {{ mongodb_config_replicaset_name }}
{% endif %}

# -----------------------------------------------------------------------------
# Sharding Settings (Shard Server)
# -----------------------------------------------------------------------------
{% if mongodb_deployment_mode == 'sharded' and not mongodb_config_server and not mongodb_mongos_router %}
sharding:
  clusterRole: shardsvr
replication:
  replSetName: {{ mongodb_replicaset_name }}
{% if mongodb_oplog_size_mb is defined and mongodb_oplog_size_mb > 0 %}
  oplogSizeMB: {{ mongodb_oplog_size_mb }}
{% endif %}
{% endif %}

# -----------------------------------------------------------------------------
# Set Parameter Settings
# -----------------------------------------------------------------------------
setParameter:
{% if mongodb_cursor_timeout_ms is defined %}
  cursorTimeoutMillis: {{ mongodb_cursor_timeout_ms }}
{% endif %}
{% if mongodb_wiredtiger_concurrent_read_transactions is defined %}
  wiredTigerConcurrentReadTransactions: {{ mongodb_wiredtiger_concurrent_read_transactions }}
{% endif %}
{% if mongodb_wiredtiger_concurrent_write_transactions is defined %}
  wiredTigerConcurrentWriteTransactions: {{ mongodb_wiredtiger_concurrent_write_transactions }}
{% endif %}
{% if mongodb_feature_compatibility_version %}
  featureCompatibilityVersion: "{{ mongodb_feature_compatibility_version }}"
{% endif %}

# -----------------------------------------------------------------------------
# Audit Settings (Enterprise Only)
# -----------------------------------------------------------------------------
{% if mongodb_audit_enabled %}
auditLog:
  destination: {{ mongodb_audit_destination }}
{% if mongodb_audit_destination == 'file' %}
  format: {{ mongodb_audit_format }}
  path: {{ mongodb_audit_path }}
{% endif %}
{% if mongodb_audit_filter %}
  filter: {{ mongodb_audit_filter }}
{% endif %}
{% endif %}

# -----------------------------------------------------------------------------
# Free Monitoring
# -----------------------------------------------------------------------------
{% if mongodb_free_monitoring_enabled %}
cloud:
  monitoring:
    free:
      state: enabled
{% endif %}

# -----------------------------------------------------------------------------
# Additional Custom Configuration
# -----------------------------------------------------------------------------
{% if mongodb_additional_config is defined and mongodb_additional_config | length > 0 %}
{{ mongodb_additional_config | to_nice_yaml }}
{% endif %}
