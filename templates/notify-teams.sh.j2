#!/bin/bash
# =============================================================================
# Microsoft Teams Notification Script
# =============================================================================

set -euo pipefail

source /opt/mongodb-alerting/alerting.conf

SEVERITY="$1"
MESSAGE="$2"
DETAILS="${3:-No additional details}"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
HOSTNAME=$(hostname -f)

case ${SEVERITY} in
    critical) COLOR="FF0000" ;;
    warning) COLOR="FFA500" ;;
    info) COLOR="00FF00" ;;
    *) COLOR="808080" ;;
esac

PAYLOAD=$(cat << EOF
{
    "@type": "MessageCard",
    "@context": "http://schema.org/extensions",
    "themeColor": "${COLOR}",
    "summary": "MongoDB Alert - ${SEVERITY}",
    "sections": [{
        "activityTitle": "MongoDB Alert - ${SEVERITY^^}",
        "activitySubtitle": "${HOSTNAME}",
        "facts": [{
            "name": "Message",
            "value": "${MESSAGE}"
        }, {
            "name": "Severity",
            "value": "${SEVERITY}"
        }, {
            "name": "Details",
            "value": "${DETAILS}"
        }, {
            "name": "Timestamp",
            "value": "${TIMESTAMP}"
        }],
        "markdown": true
    }]
}
EOF
)

curl -s -X POST \
    -H "Content-Type: application/json" \
    -d "${PAYLOAD}" \
    "${TEAMS_WEBHOOK_URL}" > /dev/null

exit 0
