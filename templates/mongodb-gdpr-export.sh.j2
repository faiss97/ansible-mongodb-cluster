#!/bin/bash
# =============================================================================
# GDPR Data Export Script
# =============================================================================
# Exports all data for a specific user for GDPR compliance.
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

usage() {
    cat << EOF
Usage: $0 -u USER_ID -d DATABASE [-c COLLECTION] [-o OUTPUT_DIR]

Options:
    -u USER_ID      User identifier to export data for
    -d DATABASE     Database to search
    -c COLLECTION   Specific collection (optional, searches all if not specified)
    -o OUTPUT_DIR   Output directory (default: /tmp/gdpr-export)
    -h              Show this help

Example:
    $0 -u "user@example.com" -d myapp
    $0 -u "12345" -d myapp -c users -o /var/export

EOF
    exit 1
}

USER_ID=""
DATABASE=""
COLLECTION=""
OUTPUT_DIR="/tmp/gdpr-export"

while getopts "u:d:c:o:h" opt; do
    case ${opt} in
        u) USER_ID="$OPTARG" ;;
        d) DATABASE="$OPTARG" ;;
        c) COLLECTION="$OPTARG" ;;
        o) OUTPUT_DIR="$OPTARG" ;;
        h) usage ;;
        *) usage ;;
    esac
done

if [ -z "${USER_ID}" ] || [ -z "${DATABASE}" ]; then
    echo "Error: User ID and database are required"
    usage
fi

MONGO_PORT="{{ mongodb_port }}"
{% if mongodb_security_auth_enabled %}
AUTH_OPTS="--username {{ mongodb_admin_user }} --password {{ mongodb_admin_password }} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

EXPORT_DIR="${OUTPUT_DIR}/gdpr_export_$(echo ${USER_ID} | md5sum | cut -c1-8)_$(date +%Y%m%d_%H%M%S)"
mkdir -p "${EXPORT_DIR}"

echo "GDPR Data Export"
echo "================"
echo "User ID: ${USER_ID}"
echo "Database: ${DATABASE}"
echo "Output: ${EXPORT_DIR}"
echo ""

# Common user identifier fields
USER_FIELDS='["user_id", "userId", "email", "user_email", "username", "customer_id", "customerId", "owner", "created_by", "modified_by"]'

if [ -n "${COLLECTION}" ]; then
    COLLECTIONS="${COLLECTION}"
else
    COLLECTIONS=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
        --eval "db.getSiblingDB('${DATABASE}').getCollectionNames().join(' ')" \
        --quiet 2>/dev/null)
fi

for coll in ${COLLECTIONS}; do
    echo "Searching collection: ${coll}..."
    
    # Build query to search multiple user identifier fields
    QUERY="{\"\\$or\": ["
    for field in user_id userId email user_email username customer_id customerId owner created_by modified_by; do
        QUERY="${QUERY}{\"${field}\": \"${USER_ID}\"},"
    done
    QUERY="${QUERY%,}]}"
    
    # Export matching documents
    COUNT=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
        --eval "db.getSiblingDB('${DATABASE}').${coll}.countDocuments(${QUERY})" \
        --quiet 2>/dev/null || echo "0")
    
    if [ "${COUNT}" -gt 0 ]; then
        echo "  Found ${COUNT} documents in ${coll}"
        
        mongoexport \
            --host localhost --port ${MONGO_PORT} \
            ${AUTH_OPTS} \
            --db ${DATABASE} \
            --collection ${coll} \
            --query "${QUERY}" \
            --out "${EXPORT_DIR}/${coll}.json" \
            2>/dev/null
    fi
done

# Create export manifest
cat > "${EXPORT_DIR}/manifest.json" << EOF
{
    "export_type": "GDPR_DATA_EXPORT",
    "user_identifier": "${USER_ID}",
    "database": "${DATABASE}",
    "export_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "exported_by": "$(whoami)@$(hostname)",
    "files": $(ls -1 ${EXPORT_DIR}/*.json 2>/dev/null | jq -R -s -c 'split("\n") | map(select(. != ""))')
}
EOF

# Create ZIP archive
ARCHIVE="${OUTPUT_DIR}/gdpr_export_$(date +%Y%m%d_%H%M%S).zip"
cd "${OUTPUT_DIR}"
zip -r "${ARCHIVE}" "$(basename ${EXPORT_DIR})"

echo ""
echo "Export complete!"
echo "Archive: ${ARCHIVE}"
echo "Manifest: ${EXPORT_DIR}/manifest.json"

exit 0
