#!/bin/bash
# =============================================================================
# MongoDB Alert Notification Script
# =============================================================================
# Sends alerts via configured notification channels.
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

# Load configuration
source /opt/mongodb-alerting/alerting.conf

# Usage
usage() {
    cat << EOF
Usage: $0 <severity> <message> [details]

Severity levels:
    critical    - Critical alert (PagerDuty triggered)
    warning     - Warning alert
    info        - Informational alert
    test        - Test notification

Examples:
    $0 critical "MongoDB primary down" "Node mongo1.example.com is unreachable"
    $0 warning "High replication lag" "Lag is 45 seconds"
    $0 test "Test notification"

EOF
    exit 1
}

if [ $# -lt 2 ]; then
    usage
fi

SEVERITY="$1"
MESSAGE="$2"
DETAILS="${3:-}"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
HOSTNAME=$(hostname -f)

# Color codes for severity
case ${SEVERITY} in
    critical)
        COLOR="#FF0000"
        EMOJI="ðŸš¨"
        ;;
    warning)
        COLOR="#FFA500"
        EMOJI="âš ï¸"
        ;;
    info)
        COLOR="#00FF00"
        EMOJI="â„¹ï¸"
        ;;
    test)
        COLOR="#808080"
        EMOJI="ðŸ§ª"
        ;;
    *)
        COLOR="#808080"
        EMOJI="ðŸ“¢"
        ;;
esac

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> /opt/mongodb-alerting/logs/alerts.log
}

log "Sending ${SEVERITY} alert: ${MESSAGE}"

# Send to Slack
{% if mongodb_alerting_slack_enabled | default(false) %}
if [ -n "${SLACK_WEBHOOK_URL:-}" ]; then
    /opt/mongodb-alerting/scripts/notify-slack.sh "${SEVERITY}" "${MESSAGE}" "${DETAILS}"
fi
{% endif %}

# Send to Teams
{% if mongodb_alerting_teams_enabled | default(false) %}
if [ -n "${TEAMS_WEBHOOK_URL:-}" ]; then
    /opt/mongodb-alerting/scripts/notify-teams.sh "${SEVERITY}" "${MESSAGE}" "${DETAILS}"
fi
{% endif %}

# Send to PagerDuty (critical only)
{% if mongodb_alerting_pagerduty_enabled | default(false) %}
if [ "${SEVERITY}" = "critical" ] && [ -n "${PAGERDUTY_ROUTING_KEY:-}" ]; then
    /opt/mongodb-alerting/scripts/notify-pagerduty.sh "${SEVERITY}" "${MESSAGE}" "${DETAILS}"
fi
{% endif %}

# Send email
{% if mongodb_alerting_email_enabled | default(false) %}
if [ -n "${ALERT_EMAIL:-}" ]; then
    /opt/mongodb-alerting/scripts/notify-email.sh "${SEVERITY}" "${MESSAGE}" "${DETAILS}"
fi
{% endif %}

# Send to webhook
{% if mongodb_alerting_webhook_enabled | default(false) %}
if [ -n "${WEBHOOK_URL:-}" ]; then
    /opt/mongodb-alerting/scripts/notify-webhook.sh "${SEVERITY}" "${MESSAGE}" "${DETAILS}"
fi
{% endif %}

log "Alert sent successfully"

exit 0
