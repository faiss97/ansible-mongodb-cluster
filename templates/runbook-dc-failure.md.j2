# MongoDB Disaster Recovery Runbook
## Datacenter Failure

**Generated by Ansible**

---

## Scenario

Primary datacenter (DC1) is offline or unreachable. Need to failover to secondary datacenter (DC2).

## Prerequisites

- Secondary datacenter nodes are operational
- Network connectivity to DC2
- MongoDB admin credentials

## Immediate Actions

### 1. Verify DC1 is Actually Down

```bash
# Try to reach DC1 nodes
{% for host in groups[mongodb_replicaset_group | default('mongodb')][:2] %}
ping -c 3 {{ host }} || echo "{{ host }} unreachable"
{% endfor %}
```

### 2. Check Replica Set Status from DC2

```bash
mongosh --host <DC2_NODE> --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    -u {{ mongodb_admin_user }} -p '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --eval "rs.status()"
```

### 3. Force Reconfiguration (if no primary)

**⚠️ WARNING: Only if DC1 is confirmed down and won't recover soon**

```bash
# Connect to a DC2 secondary
mongosh --host <DC2_NODE> --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    -u {{ mongodb_admin_user }} -p '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --eval "
      var cfg = rs.conf();
      // Remove DC1 members or set priority to 0
      cfg.members.forEach(m => {
        if (m.host.includes('dc1')) {
          m.priority = 0;
          m.votes = 0;
        }
      });
      rs.reconfig(cfg, {force: true});
    "
```

### 4. Verify New Primary Election

```bash
mongosh --eval "rs.status().members.filter(m => m.stateStr === 'PRIMARY')"
```

## Recovery (When DC1 Returns)

### 1. Verify DC1 Nodes Status

```bash
# Check if MongoDB is running
systemctl status mongod
```

### 2. Let Nodes Rejoin as Secondaries

They should automatically sync from the new primary.

### 3. Restore Original Configuration

```bash
mongosh --eval "
  var cfg = rs.conf();
  cfg.members.forEach(m => {
    // Restore original priorities
  });
  rs.reconfig(cfg);
"
```

## Contacts

- DBA Team: {{ mongodb_dba_contact | default('dba@example.com') }}
- Network Team: {{ mongodb_network_contact | default('network@example.com') }}
