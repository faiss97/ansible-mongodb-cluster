#!/bin/bash
# =============================================================================
# Chaos Test: Automated Failover Testing
# =============================================================================
# Tests MongoDB failover using rs.stepDown() for controlled testing.
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

RESULTS_DIR="/opt/mongodb-chaos/results"
LOG_FILE="${RESULTS_DIR}/failover-test-$(date +%Y%m%d_%H%M%S).log"
MONGO_PORT="{{ mongodb_port }}"

{% if mongodb_security_auth_enabled %}
AUTH_OPTS="--username {{ mongodb_admin_user }} --password {{ mongodb_admin_password }} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

log "Starting Controlled Failover Test"
log "=================================="

# Get current primary
PRIMARY=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.status().members.find(m => m.stateStr === 'PRIMARY').name" \
    --quiet 2>/dev/null)

log "Current primary: ${PRIMARY}"

# Get number of healthy secondaries
SECONDARIES=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.status().members.filter(m => m.stateStr === 'SECONDARY' && m.health === 1).length" \
    --quiet 2>/dev/null)

if [ "${SECONDARIES}" -lt 1 ]; then
    log "ERROR: No healthy secondaries available for failover"
    exit 1
fi

log "Healthy secondaries: ${SECONDARIES}"

# Record start time
START_TIME=$(date +%s.%N)

# Initiate stepDown
log "Initiating rs.stepDown()..."
mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.stepDown(60, 30)" --quiet 2>/dev/null || true

# Wait for new primary
log "Waiting for new primary election..."

NEW_PRIMARY=""
TIMEOUT=30
ELAPSED=0

while [ ${ELAPSED} -lt ${TIMEOUT} ]; do
    sleep 1
    ELAPSED=$((ELAPSED + 1))
    
    NEW_PRIMARY=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
        --eval "rs.status().members.find(m => m.stateStr === 'PRIMARY')?.name || ''" \
        --quiet 2>/dev/null || echo "")
    
    if [ -n "${NEW_PRIMARY}" ]; then
        break
    fi
done

END_TIME=$(date +%s.%N)
ELECTION_TIME=$(echo "${END_TIME} - ${START_TIME}" | bc)

if [ -n "${NEW_PRIMARY}" ]; then
    log "SUCCESS: New primary: ${NEW_PRIMARY}"
    log "Election time: ${ELECTION_TIME} seconds"
    STATUS="PASSED"
else
    log "FAILED: No primary elected within ${TIMEOUT} seconds"
    STATUS="FAILED"
fi

# Verify write capability
log "Testing write capability on new primary..."
WRITE_TEST=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval '
        try {
            db.getSiblingDB("test").chaos_test.insertOne({test: "failover", ts: new Date()});
            print("WRITE_OK");
        } catch(e) {
            print("WRITE_FAILED: " + e.message);
        }
    ' --quiet 2>/dev/null || echo "WRITE_FAILED")

log "Write test result: ${WRITE_TEST}"

log ""
log "Test Results Summary"
log "===================="
log "Original Primary: ${PRIMARY}"
log "New Primary: ${NEW_PRIMARY:-N/A}"
log "Election Time: ${ELECTION_TIME} seconds"
log "Write Test: ${WRITE_TEST}"
log "Test Status: ${STATUS}"

# Save results
cat > "${RESULTS_DIR}/failover-test-latest.json" << EOF
{
    "test": "controlled-failover",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "original_primary": "${PRIMARY}",
    "new_primary": "${NEW_PRIMARY:-null}",
    "election_time_seconds": ${ELECTION_TIME},
    "write_test": "${WRITE_TEST}",
    "status": "${STATUS}"
}
EOF

exit $([ "${STATUS}" = "PASSED" ] && echo 0 || echo 1)
