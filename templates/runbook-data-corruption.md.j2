# MongoDB Disaster Recovery Runbook
## Data Corruption

**Generated by Ansible**

---

## Scenario

Data corruption detected in MongoDB cluster.

## Detection Signs

- mongod fails to start with corruption errors
- Collection validation failures
- Unexpected query results
- WiredTiger errors in logs

## Immediate Actions

### 1. Stop Writes

```bash
# On primary
mongosh --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    -u {{ mongodb_admin_user }} -p '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --eval "db.fsyncLock()"
```

### 2. Validate Collections

```bash
mongosh --eval "
  db.adminCommand({listDatabases: 1}).databases.forEach(d => {
    print('Validating: ' + d.name);
    db.getSiblingDB(d.name).getCollectionNames().forEach(c => {
      var result = db.getSiblingDB(d.name).runCommand({validate: c});
      if (!result.valid) print('CORRUPT: ' + d.name + '.' + c);
    });
  });
"
```

### 3. If Corruption is Isolated

Use `mongod --repair` on affected node (offline).

### 4. If Widespread Corruption

Restore from backup:

```bash
# Find latest clean backup
ls -lt {{ mongodb_backup_directory }}/*.tar.gz

# Use PITR to restore
/usr/local/bin/mongodb-pitr-restore.sh -t "TIMESTAMP_BEFORE_CORRUPTION"
```

### 5. Unlock After Recovery

```bash
mongosh --eval "db.fsyncUnlock()"
```

## Prevention

- Regular backup verification
- Enable journaling (default)
- Use ECC memory
- Monitor disk health
