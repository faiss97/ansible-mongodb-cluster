#!/bin/bash
# =============================================================================
# Generic Webhook Notification Script
# =============================================================================

set -euo pipefail

source /opt/mongodb-alerting/alerting.conf

SEVERITY="$1"
MESSAGE="$2"
DETAILS="${3:-No additional details}"
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
HOSTNAME=$(hostname -f)

PAYLOAD=$(cat << EOF
{
    "event": "mongodb_alert",
    "severity": "${SEVERITY}",
    "message": "${MESSAGE}",
    "details": "${DETAILS}",
    "hostname": "${HOSTNAME}",
    "timestamp": "${TIMESTAMP}",
    "source": "mongodb-alerting"
}
EOF
)

curl -s -X POST \
    -H "Content-Type: application/json" \
    ${WEBHOOK_AUTH_HEADER:+-H "Authorization: ${WEBHOOK_AUTH_HEADER}"} \
    -d "${PAYLOAD}" \
    "${WEBHOOK_URL}" > /dev/null

exit 0
