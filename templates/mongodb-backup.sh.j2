#!/bin/bash
# =============================================================================
# MongoDB Backup Script
# =============================================================================
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

# Configuration
BACKUP_DIR="{{ mongodb_backup_directory }}"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="mongodb_backup_${DATE}"
BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"
LOG_FILE="${BACKUP_DIR}/logs/backup_${DATE}.log"
RETENTION_DAYS="{{ mongodb_backup_retention_days }}"

# MongoDB connection settings
MONGO_HOST="localhost"
MONGO_PORT="{{ mongodb_port }}"
{% if mongodb_security_auth_enabled %}
MONGO_USER="{{ mongodb_backup_user }}"
MONGO_PASS="{{ mongodb_backup_password }}"
AUTH_OPTS="--username ${MONGO_USER} --password ${MONGO_PASS} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

# Compression settings
{% if mongodb_backup_compression %}
COMPRESSION_OPTS="--gzip"
{% else %}
COMPRESSION_OPTS=""
{% endif %}

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

# Error handling
error_exit() {
    log "ERROR: $1"
    exit 1
}

# Create backup directory
mkdir -p "${BACKUP_PATH}"
mkdir -p "${BACKUP_DIR}/logs"

log "Starting MongoDB backup: ${BACKUP_NAME}"

{% if mongodb_deployment_mode == 'replicaset' %}
# For replica set, backup from secondary if available
SECONDARY=$(mongosh --host ${MONGO_HOST} --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.status().members.find(m => m.stateStr === 'SECONDARY')?.name || 'localhost:${MONGO_PORT}'" \
    --quiet 2>/dev/null || echo "localhost:${MONGO_PORT}")

log "Backing up from: ${SECONDARY}"
BACKUP_HOST="${SECONDARY}"
{% else %}
BACKUP_HOST="${MONGO_HOST}:${MONGO_PORT}"
{% endif %}

# Run mongodump
log "Running mongodump..."
mongodump \
    --host "${BACKUP_HOST}" \
    ${AUTH_OPTS} \
    --out "${BACKUP_PATH}" \
    ${COMPRESSION_OPTS} \
    --oplog \
    2>&1 | tee -a "${LOG_FILE}"

if [ $? -ne 0 ]; then
    error_exit "mongodump failed"
fi

# Calculate backup size
BACKUP_SIZE=$(du -sh "${BACKUP_PATH}" | cut -f1)
log "Backup completed. Size: ${BACKUP_SIZE}"

# Create checksum
log "Creating checksum..."
cd "${BACKUP_DIR}"
find "${BACKUP_NAME}" -type f -exec sha256sum {} \; > "${BACKUP_NAME}.sha256"

# Create tarball (optional)
log "Creating archive..."
tar -czf "${BACKUP_NAME}.tar.gz" "${BACKUP_NAME}"
rm -rf "${BACKUP_PATH}"

{% if mongodb_backup_s3_enabled %}
# Upload to S3
log "Uploading to S3..."
/usr/local/bin/mongodb-backup-s3.sh "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"
{% endif %}

log "Backup ${BACKUP_NAME} completed successfully"

# Run cleanup
/usr/local/bin/mongodb-backup-cleanup.sh

exit 0
