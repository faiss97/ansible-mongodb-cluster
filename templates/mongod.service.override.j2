# =============================================================================
# MongoDB Service Override Configuration
# =============================================================================
# Generated by Ansible - Do not edit manually
# =============================================================================

[Unit]
After=network-online.target
Wants=network-online.target
{% if mongodb_disable_thp %}
After=disable-transparent-hugepages.service
Requires=disable-transparent-hugepages.service
{% endif %}

[Service]
# Resource limits
LimitFSIZE=infinity
LimitCPU=infinity
LimitAS=infinity
LimitNOFILE={{ mongodb_limit_nofile }}
LimitNPROC={{ mongodb_limit_nproc }}
LimitMEMLOCK={{ mongodb_limit_memlock }}

# Restart policy
Restart=on-failure
RestartSec=5

# User and group
User={{ mongodb_user }}
Group={{ mongodb_group }}

# Environment variables
{% if mongodb_environment_variables is defined and mongodb_environment_variables | length > 0 %}
{% for key, value in mongodb_environment_variables.items() %}
Environment="{{ key }}={{ value }}"
{% endfor %}
{% endif %}

# NUMA settings
{% if mongodb_disable_numa %}
ExecStart=
ExecStart=/usr/bin/numactl --interleave=all /usr/bin/mongod --config {{ mongodb_config_file }}
{% endif %}

# OOM score adjustment (make MongoDB less likely to be killed)
OOMScoreAdjust=-500

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectHome=read-only
ProtectSystem=full
