#!/bin/bash
# =============================================================================
# MongoDB Oplog Tailer for Point-in-Time Recovery
# =============================================================================
# Continuously tails the oplog and saves it for PITR capability.
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

# Configuration
PITR_DIR="{{ mongodb_pitr_directory }}"
OPLOG_DIR="${PITR_DIR}/oplog"
LOG_FILE="${PITR_DIR}/logs/oplog-tailer.log"
STATE_FILE="${PITR_DIR}/state/last_ts"

# MongoDB connection
MONGO_HOST="localhost"
MONGO_PORT="{{ mongodb_port }}"
{% if mongodb_security_auth_enabled %}
MONGO_USER="{{ mongodb_backup_user }}"
MONGO_PASS="{{ mongodb_backup_password }}"
AUTH_OPTS="--username ${MONGO_USER} --password ${MONGO_PASS} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

# Get last timestamp
get_last_ts() {
    if [ -f "${STATE_FILE}" ]; then
        cat "${STATE_FILE}"
    else
        # Start from current time
        mongosh --host ${MONGO_HOST} --port ${MONGO_PORT} ${AUTH_OPTS} \
            --eval "Timestamp(Math.floor(Date.now()/1000), 0)" --quiet
    fi
}

# Save current timestamp
save_ts() {
    echo "$1" > "${STATE_FILE}"
}

# Main oplog tailing loop
tail_oplog() {
    local LAST_TS=$(get_last_ts)
    local OUTPUT_FILE="${OPLOG_DIR}/oplog_$(date +%Y%m%d_%H%M%S).bson"
    
    log "Starting oplog tail from timestamp: ${LAST_TS}"
    log "Output file: ${OUTPUT_FILE}"
    
    # Use mongodump to capture oplog
    mongodump \
        --host ${MONGO_HOST} --port ${MONGO_PORT} \
        ${AUTH_OPTS} \
        --db local \
        --collection oplog.rs \
        --query "{\"ts\": {\"\$gt\": ${LAST_TS}}}" \
        --out - \
        > "${OUTPUT_FILE}" 2>> "${LOG_FILE}"
    
    if [ $? -eq 0 ] && [ -s "${OUTPUT_FILE}" ]; then
        # Get the latest timestamp from the captured oplog
        NEW_TS=$(mongosh --host ${MONGO_HOST} --port ${MONGO_PORT} ${AUTH_OPTS} \
            --eval "db.getSiblingDB('local').oplog.rs.find().sort({\$natural:-1}).limit(1).next().ts" \
            --quiet 2>/dev/null || echo "${LAST_TS}")
        
        save_ts "${NEW_TS}"
        log "Captured oplog entries. New timestamp: ${NEW_TS}"
    else
        log "No new oplog entries or error occurred"
        rm -f "${OUTPUT_FILE}"
    fi
}

# Cleanup function
cleanup() {
    log "Oplog tailer shutting down"
    exit 0
}

trap cleanup SIGTERM SIGINT

log "Oplog tailer started"

# Main loop
while true; do
    tail_oplog
    sleep {{ mongodb_pitr_tail_interval | default(60) }}
done
