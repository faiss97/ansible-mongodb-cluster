#!/bin/bash
# =============================================================================
# MongoDB CIS Benchmark Security Check
# =============================================================================
# Checks MongoDB configuration against CIS Benchmark recommendations
# Generated by ansible-mongodb-cluster
# =============================================================================

set -euo pipefail

REPORT_FILE="/opt/mongodb-compliance/reports/cis-benchmark-$(date +%Y%m%d).md"
PASS_COUNT=0
FAIL_COUNT=0
WARN_COUNT=0

MONGO_PORT="${MONGO_PORT:-27017}"
{% if mongodb_security_auth_enabled %}
AUTH_OPTS="--username {{ mongodb_admin_user }} --password {{ mongodb_admin_password }} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

# Colors for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

log_pass() {
    echo -e "${GREEN}[PASS]${NC} $1"
    echo "- ✅ **PASS**: $1" >> "${REPORT_FILE}"
    ((PASS_COUNT++))
}

log_fail() {
    echo -e "${RED}[FAIL]${NC} $1"
    echo "- ❌ **FAIL**: $1" >> "${REPORT_FILE}"
    ((FAIL_COUNT++))
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    echo "- ⚠️ **WARN**: $1" >> "${REPORT_FILE}"
    ((WARN_COUNT++))
}

mkdir -p "$(dirname ${REPORT_FILE})"

cat > "${REPORT_FILE}" << EOF
# MongoDB CIS Benchmark Security Report
Generated: $(date)
Host: $(hostname)

---

## Summary

EOF

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║           MongoDB CIS Benchmark Security Check                    ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""

echo "## 1. Installation and Updates" >> "${REPORT_FILE}"
echo ""
echo "### 1. Installation and Updates"

# 1.1 Ensure MongoDB is installed from official repository
if grep -q "repo.mongodb.org" /etc/apt/sources.list.d/* 2>/dev/null || \
   grep -q "repo.mongodb.org" /etc/yum.repos.d/* 2>/dev/null; then
    log_pass "1.1 MongoDB installed from official repository"
else
    log_warn "1.1 Cannot verify official repository"
fi

# 1.2 Ensure MongoDB version is current
MONGO_VERSION=$(mongod --version 2>/dev/null | grep "db version" | awk '{print $3}' | sed 's/v//')
if [[ -n "${MONGO_VERSION}" ]]; then
    log_pass "1.2 MongoDB version: ${MONGO_VERSION}"
else
    log_fail "1.2 Cannot determine MongoDB version"
fi

echo ""
echo "## 2. Authentication" >> "${REPORT_FILE}"
echo ""
echo "### 2. Authentication"

# 2.1 Ensure authentication is enabled
AUTH_ENABLED=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "db.adminCommand({getParameter: 1, authenticationMechanisms: 1})" \
    --quiet 2>/dev/null | grep -c "SCRAM" || echo "0")
if [[ "${AUTH_ENABLED}" -gt 0 ]]; then
    log_pass "2.1 Authentication is enabled"
else
    log_fail "2.1 Authentication is NOT enabled"
fi

# 2.2 Ensure authorization is enabled
AUTHZ_STATUS=$(grep -E "^[[:space:]]*authorization:" /etc/mongod.conf 2>/dev/null | awk '{print $2}')
if [[ "${AUTHZ_STATUS}" == "enabled" ]]; then
    log_pass "2.2 Authorization is enabled"
else
    log_fail "2.2 Authorization is NOT enabled"
fi

# 2.3 Ensure localhost authentication bypass is disabled
LOCALHOST_BYPASS=$(grep -c "enableLocalhostAuthBypass" /etc/mongod.conf 2>/dev/null || echo "0")
if [[ "${LOCALHOST_BYPASS}" -eq 0 ]]; then
    log_pass "2.3 Localhost auth bypass is disabled (default)"
else
    log_warn "2.3 Check localhost auth bypass setting"
fi

echo ""
echo "## 3. Access Control" >> "${REPORT_FILE}"
echo ""
echo "### 3. Access Control"

# 3.1 Ensure minimum roles are used
USER_COUNT=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "db.getSiblingDB('admin').getUsers().length" \
    --quiet 2>/dev/null || echo "0")
if [[ "${USER_COUNT}" -gt 0 ]]; then
    log_pass "3.1 ${USER_COUNT} users configured"
else
    log_fail "3.1 No users configured"
fi

# 3.2 Ensure superuser access is restricted
SUPERUSERS=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "db.getSiblingDB('admin').getUsers().filter(u => u.roles.some(r => r.role === 'root')).length" \
    --quiet 2>/dev/null || echo "0")
if [[ "${SUPERUSERS}" -le 2 ]]; then
    log_pass "3.2 Superuser access is restricted (${SUPERUSERS} root users)"
else
    log_warn "3.2 Multiple root users found (${SUPERUSERS})"
fi

echo ""
echo "## 4. Encryption" >> "${REPORT_FILE}"
echo ""
echo "### 4. Encryption"

# 4.1 Ensure TLS is enabled
TLS_MODE=$(grep -E "^[[:space:]]*(mode|sslMode):" /etc/mongod.conf 2>/dev/null | head -1 | awk '{print $2}')
if [[ "${TLS_MODE}" == "requireSSL" || "${TLS_MODE}" == "requireTLS" ]]; then
    log_pass "4.1 TLS is required (${TLS_MODE})"
elif [[ "${TLS_MODE}" == "preferSSL" || "${TLS_MODE}" == "preferTLS" ]]; then
    log_warn "4.1 TLS is preferred but not required (${TLS_MODE})"
else
    log_fail "4.1 TLS is NOT enabled"
fi

# 4.2 Ensure keyfile authentication is configured for replica sets
if [[ -f /etc/mongodb-keyfile ]] || [[ -f {{ mongodb_keyfile_path | default('/etc/mongodb-keyfile') }} ]]; then
    KEYFILE_PERMS=$(stat -c %a {{ mongodb_keyfile_path | default('/etc/mongodb-keyfile') }} 2>/dev/null || echo "000")
    if [[ "${KEYFILE_PERMS}" == "400" || "${KEYFILE_PERMS}" == "600" ]]; then
        log_pass "4.2 Keyfile configured with correct permissions (${KEYFILE_PERMS})"
    else
        log_warn "4.2 Keyfile permissions should be 400 or 600 (current: ${KEYFILE_PERMS})"
    fi
else
    log_warn "4.2 No keyfile found (may be standalone deployment)"
fi

echo ""
echo "## 5. Network Configuration" >> "${REPORT_FILE}"
echo ""
echo "### 5. Network Configuration"

# 5.1 Ensure bind_ip is configured
BIND_IP=$(grep -E "^[[:space:]]*bindIp:" /etc/mongod.conf 2>/dev/null | awk '{print $2}')
if [[ -n "${BIND_IP}" && "${BIND_IP}" != "0.0.0.0" ]]; then
    log_pass "5.1 Network binding is restricted (${BIND_IP})"
elif [[ "${BIND_IP}" == "0.0.0.0" ]]; then
    log_warn "5.1 MongoDB is bound to all interfaces"
else
    log_warn "5.1 Cannot determine bind_ip setting"
fi

# 5.2 Ensure MongoDB port is not default (optional)
if [[ "${MONGO_PORT}" != "27017" ]]; then
    log_pass "5.2 Non-default port in use (${MONGO_PORT})"
else
    log_warn "5.2 Using default port 27017"
fi

echo ""
echo "## 6. Logging and Auditing" >> "${REPORT_FILE}"
echo ""
echo "### 6. Logging and Auditing"

# 6.1 Ensure logging is enabled
LOG_DEST=$(grep -E "^[[:space:]]*destination:" /etc/mongod.conf 2>/dev/null | awk '{print $2}')
if [[ "${LOG_DEST}" == "file" || "${LOG_DEST}" == "syslog" ]]; then
    log_pass "6.1 Logging is enabled (${LOG_DEST})"
else
    log_warn "6.1 Logging destination not explicitly configured"
fi

# 6.2 Ensure log path is configured
LOG_PATH=$(grep -E "^[[:space:]]*path:" /etc/mongod.conf 2>/dev/null | head -1 | awk '{print $2}')
if [[ -n "${LOG_PATH}" && -f "${LOG_PATH}" ]]; then
    log_pass "6.2 Log file exists (${LOG_PATH})"
else
    log_warn "6.2 Log path not configured or file doesn't exist"
fi

echo ""
echo "## 7. Operating System Hardening" >> "${REPORT_FILE}"
echo ""
echo "### 7. Operating System Hardening"

# 7.1 Ensure MongoDB user is non-privileged
MONGO_USER=$(ps -o user= -p $(pgrep mongod 2>/dev/null | head -1) 2>/dev/null || echo "unknown")
if [[ "${MONGO_USER}" == "mongod" || "${MONGO_USER}" == "mongodb" ]]; then
    log_pass "7.1 MongoDB running as non-privileged user (${MONGO_USER})"
else
    log_warn "7.1 MongoDB user: ${MONGO_USER}"
fi

# 7.2 Ensure data directory permissions
DATA_DIR="{{ mongodb_data_directory | default('/var/lib/mongo') }}"
if [[ -d "${DATA_DIR}" ]]; then
    DATA_PERMS=$(stat -c %a "${DATA_DIR}" 2>/dev/null || echo "000")
    DATA_OWNER=$(stat -c %U "${DATA_DIR}" 2>/dev/null || echo "unknown")
    if [[ "${DATA_PERMS}" == "750" || "${DATA_PERMS}" == "700" ]] && \
       [[ "${DATA_OWNER}" == "mongod" || "${DATA_OWNER}" == "mongodb" ]]; then
        log_pass "7.2 Data directory permissions correct (${DATA_PERMS}, owner: ${DATA_OWNER})"
    else
        log_warn "7.2 Check data directory permissions (${DATA_PERMS}, owner: ${DATA_OWNER})"
    fi
else
    log_fail "7.2 Data directory not found: ${DATA_DIR}"
fi

# 7.3 Ensure transparent huge pages are disabled
THP_STATUS=$(cat /sys/kernel/mm/transparent_hugepage/enabled 2>/dev/null | grep -o '\[.*\]' | tr -d '[]')
if [[ "${THP_STATUS}" == "never" ]]; then
    log_pass "7.3 Transparent Huge Pages are disabled"
else
    log_warn "7.3 Transparent Huge Pages should be disabled (current: ${THP_STATUS})"
fi

echo ""
echo "## 8. Replication" >> "${REPORT_FILE}"
echo ""
echo "### 8. Replication"

# 8.1 Ensure replica set authentication is enabled
RS_STATUS=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.status().ok" --quiet 2>/dev/null || echo "0")
if [[ "${RS_STATUS}" == "1" ]]; then
    log_pass "8.1 Replica set is configured"
else
    log_warn "8.1 Replica set not configured (may be standalone)"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════════"
echo ""

# Summary
cat >> "${REPORT_FILE}" << EOF

---

## Results Summary

| Status | Count |
|--------|-------|
| PASS   | ${PASS_COUNT} |
| FAIL   | ${FAIL_COUNT} |
| WARN   | ${WARN_COUNT} |

**Total Checks**: $((PASS_COUNT + FAIL_COUNT + WARN_COUNT))

---

*Report generated by ansible-mongodb-cluster CIS Benchmark checker*
EOF

echo "Results Summary:"
echo "  PASS: ${PASS_COUNT}"
echo "  FAIL: ${FAIL_COUNT}"
echo "  WARN: ${WARN_COUNT}"
echo ""
echo "Full report saved to: ${REPORT_FILE}"

# Exit with failure if any critical checks failed
if [[ ${FAIL_COUNT} -gt 0 ]]; then
    exit 1
fi

exit 0
