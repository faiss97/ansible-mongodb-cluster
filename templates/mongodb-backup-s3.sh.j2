#!/bin/bash
# =============================================================================
# MongoDB Backup S3 Upload Script
# =============================================================================
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

BACKUP_FILE="$1"
S3_BUCKET="{{ mongodb_backup_s3_bucket }}"
S3_PREFIX="{{ mongodb_backup_s3_prefix }}"
DATE=$(date +%Y/%m/%d)

if [ -z "${BACKUP_FILE}" ]; then
    echo "Usage: $0 <backup_file>"
    exit 1
fi

if [ ! -f "${BACKUP_FILE}" ]; then
    echo "Backup file not found: ${BACKUP_FILE}"
    exit 1
fi

FILENAME=$(basename "${BACKUP_FILE}")
S3_PATH="s3://${S3_BUCKET}/${S3_PREFIX}/${DATE}/${FILENAME}"

echo "Uploading ${BACKUP_FILE} to ${S3_PATH}..."

aws s3 cp "${BACKUP_FILE}" "${S3_PATH}" \
    --storage-class STANDARD_IA \
    --only-show-errors

# Also upload checksum
CHECKSUM_FILE="${BACKUP_FILE%.tar.gz}.sha256"
if [ -f "${CHECKSUM_FILE}" ]; then
    aws s3 cp "${CHECKSUM_FILE}" "${S3_PATH%.tar.gz}.sha256" \
        --storage-class STANDARD_IA \
        --only-show-errors
fi

echo "Upload completed: ${S3_PATH}"

# Clean old S3 backups (optional - handled by S3 lifecycle policy)
# aws s3 ls "s3://${S3_BUCKET}/${S3_PREFIX}/" --recursive | \
#     while read -r line; do ... done

exit 0
