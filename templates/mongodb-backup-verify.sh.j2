#!/bin/bash
# =============================================================================
# MongoDB Backup Verification Script
# =============================================================================
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

BACKUP_DIR="{{ mongodb_backup_directory }}"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Find the most recent backup
LATEST_BACKUP=$(ls -t "${BACKUP_DIR}"/mongodb_backup_*.tar.gz 2>/dev/null | head -1)

if [ -z "${LATEST_BACKUP}" ]; then
    log "ERROR: No backup files found"
    exit 1
fi

log "Verifying backup: ${LATEST_BACKUP}"

# Verify checksum
CHECKSUM_FILE="${LATEST_BACKUP%.tar.gz}.sha256"
if [ -f "${CHECKSUM_FILE}" ]; then
    log "Verifying checksums..."
    
    # Extract and verify
    TEMP_DIR=$(mktemp -d)
    trap "rm -rf ${TEMP_DIR}" EXIT
    
    tar -xzf "${LATEST_BACKUP}" -C "${TEMP_DIR}"
    
    cd "${TEMP_DIR}"
    if sha256sum -c "${CHECKSUM_FILE}" > /dev/null 2>&1; then
        log "Checksum verification: PASSED"
    else
        log "ERROR: Checksum verification FAILED"
        exit 1
    fi
else
    log "WARNING: Checksum file not found, skipping verification"
fi

# Verify backup structure
log "Verifying backup structure..."
BACKUP_NAME=$(basename "${LATEST_BACKUP}" .tar.gz)

if [ -d "${TEMP_DIR}/${BACKUP_NAME}" ]; then
    # Check for admin database (always present)
    if [ -d "${TEMP_DIR}/${BACKUP_NAME}/admin" ]; then
        log "Admin database: FOUND"
    else
        log "WARNING: Admin database not found in backup"
    fi
    
    # List databases in backup
    log "Databases in backup:"
    ls -la "${TEMP_DIR}/${BACKUP_NAME}/" | grep "^d" | awk '{print "  - " $NF}'
    
    # Check for oplog (for replica sets)
    if [ -f "${TEMP_DIR}/${BACKUP_NAME}/oplog.bson" ] || \
       [ -f "${TEMP_DIR}/${BACKUP_NAME}/oplog.bson.gz" ]; then
        log "Oplog: FOUND (point-in-time recovery possible)"
    else
        log "Oplog: NOT FOUND"
    fi
fi

# Calculate backup age
BACKUP_DATE=$(stat -c %Y "${LATEST_BACKUP}")
CURRENT_DATE=$(date +%s)
AGE_HOURS=$(( (CURRENT_DATE - BACKUP_DATE) / 3600 ))

log "Backup age: ${AGE_HOURS} hours"

if [ ${AGE_HOURS} -gt 48 ]; then
    log "WARNING: Backup is more than 48 hours old!"
fi

log "Backup verification completed successfully"

exit 0
