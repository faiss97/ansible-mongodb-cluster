# MongoDB Disaster Recovery Runbook
## Complete Cluster Failure

**Generated by Ansible** - Last updated: {{ ansible_date_time.iso8601 }}

---

## Overview

This runbook covers the procedure for recovering from a complete MongoDB cluster failure where all nodes are down or data is corrupted.

## Prerequisites

- Access to backup storage
- SSH access to MongoDB servers
- MongoDB admin credentials
- Latest backup location: `{{ mongodb_backup_directory }}`

## Recovery Procedure

### Step 1: Assess the Situation

```bash
# Check all nodes status
{% for host in groups[mongodb_replicaset_group | default('mongodb')] %}
ssh {{ host }} "systemctl status {{ mongodb_service_name }}"
{% endfor %}

# Check for data corruption
ls -la {{ mongodb_data_directory }}/
```

### Step 2: Stop All MongoDB Instances

```bash
{% for host in groups[mongodb_replicaset_group | default('mongodb')] %}
ssh {{ host }} "systemctl stop {{ mongodb_service_name }}"
{% endfor %}
```

### Step 3: Backup Current (Corrupted) Data

```bash
{% for host in groups[mongodb_replicaset_group | default('mongodb')] %}
ssh {{ host }} "mv {{ mongodb_data_directory }} {{ mongodb_data_directory }}.corrupted.$(date +%Y%m%d)"
ssh {{ host }} "mkdir -p {{ mongodb_data_directory }}"
ssh {{ host }} "chown {{ mongodb_user }}:{{ mongodb_group }} {{ mongodb_data_directory }}"
{% endfor %}
```

### Step 4: Identify Latest Good Backup

```bash
ls -lt {{ mongodb_backup_directory }}/*.tar.gz | head -5
```

### Step 5: Restore from Backup

On the PRIMARY node ({{ groups[mongodb_replicaset_group | default('mongodb')][0] }}):

```bash
# Extract backup
BACKUP_FILE=$(ls -t {{ mongodb_backup_directory }}/*.tar.gz | head -1)
tar -xzf ${BACKUP_FILE} -C /tmp/

# Restore data
mongorestore \
    --host localhost --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    --username {{ mongodb_admin_user }} \
    --password '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --drop \
    /tmp/mongodb_backup_*/
```

### Step 6: Start MongoDB on Primary

```bash
systemctl start {{ mongodb_service_name }}

# Wait for startup
sleep 30

# Verify
mongosh --port {{ mongodb_port }} --eval "rs.status()"
```

### Step 7: Start Secondary Nodes

```bash
{% for host in groups[mongodb_replicaset_group | default('mongodb')][1:] %}
ssh {{ host }} "systemctl start {{ mongodb_service_name }}"
sleep 30
{% endfor %}
```

### Step 8: Verify Cluster Health

```bash
mongosh --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    -u {{ mongodb_admin_user }} -p '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --eval "rs.status()"
```

### Step 9: Verify Data Integrity

```bash
mongosh --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    -u {{ mongodb_admin_user }} -p '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --eval "db.adminCommand({listDatabases: 1})"
```

## Post-Recovery Checklist

- [ ] All replica set members are healthy
- [ ] Primary is elected
- [ ] Replication is working
- [ ] Application connectivity restored
- [ ] Alerts cleared
- [ ] Incident documented

## Contacts

- DBA Team: {{ mongodb_dba_contact | default('dba@example.com') }}
- On-Call: {{ mongodb_oncall_contact | default('oncall@example.com') }}

## Related Runbooks

- [Datacenter Failure](datacenter-failure.md)
- [Network Partition](network-partition.md)
- [Data Corruption](data-corruption.md)
