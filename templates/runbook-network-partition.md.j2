# MongoDB Disaster Recovery Runbook
## Network Partition

**Generated by Ansible**

---

## Scenario

Network partition (split-brain) detected between MongoDB nodes.

## Detection

Signs of network partition:
- Multiple nodes claiming PRIMARY
- Nodes showing each other as unreachable
- Application connection errors

## Immediate Actions

### 1. Identify Partition Boundaries

```bash
# Check from each node
{% for host in groups[mongodb_replicaset_group | default('mongodb')] %}
echo "=== {{ host }} ==="
ssh {{ host }} "mongosh --port {{ mongodb_port }} --eval 'rs.status().members.map(m => ({name: m.name, state: m.stateStr, health: m.health}))'"
{% endfor %}
```

### 2. Determine Which Side Has Majority

The side with majority of voting members will elect a primary.

### 3. If No Majority Exists

All nodes become SECONDARY. Applications cannot write.

**Wait for network recovery** - this is the safest option.

### 4. Emergency: Force Primary (DATA LOSS RISK)

**⚠️ ONLY if network won't recover and writes are critical**

```bash
# On the node you want as primary
mongosh --port {{ mongodb_port }} \
{% if mongodb_security_auth_enabled %}
    -u {{ mongodb_admin_user }} -p '{{ mongodb_admin_password }}' \
    --authenticationDatabase admin \
{% endif %}
    --eval "rs.reconfig(rs.conf(), {force: true})"
```

## Post-Recovery

After network is restored:

1. Check for data divergence
2. Resync nodes if necessary
3. Review oplog for conflicts
4. Document incident
