#!/bin/bash
# =============================================================================
# Chaos Test: Kill Primary Node
# =============================================================================
# Tests replica set failover by killing the primary node.
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

RESULTS_DIR="/opt/mongodb-chaos/results"
LOG_FILE="${RESULTS_DIR}/kill-primary-$(date +%Y%m%d_%H%M%S).log"
MONGO_PORT="{{ mongodb_port }}"

{% if mongodb_security_auth_enabled %}
AUTH_OPTS="--username {{ mongodb_admin_user }} --password {{ mongodb_admin_password }} --authenticationDatabase admin"
{% else %}
AUTH_OPTS=""
{% endif %}

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

log "Starting Primary Kill Test"
log "==========================="

# Get current primary
PRIMARY=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.status().members.find(m => m.stateStr === 'PRIMARY').name" \
    --quiet 2>/dev/null)

if [ -z "${PRIMARY}" ]; then
    log "ERROR: Could not determine primary"
    exit 1
fi

log "Current primary: ${PRIMARY}"

# Record start time
START_TIME=$(date +%s.%N)

# Kill primary (simulate crash)
log "Killing primary MongoDB process..."
PRIMARY_HOST=$(echo ${PRIMARY} | cut -d: -f1)

if [ "${PRIMARY_HOST}" = "$(hostname)" ] || [ "${PRIMARY_HOST}" = "localhost" ]; then
    # Kill local MongoDB
    pkill -9 -f "mongod.*--port.*${MONGO_PORT}" || true
else
    log "Primary is on remote host. Use SSH to kill: ssh ${PRIMARY_HOST} 'pkill -9 mongod'"
    exit 1
fi

log "Primary killed at $(date)"

# Wait for new primary election
log "Waiting for new primary election..."

ELECTION_COMPLETE=false
TIMEOUT=60
ELAPSED=0

while [ ${ELAPSED} -lt ${TIMEOUT} ]; do
    sleep 1
    ELAPSED=$((ELAPSED + 1))
    
    NEW_PRIMARY=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
        --eval "rs.status().members.find(m => m.stateStr === 'PRIMARY')?.name || ''" \
        --quiet 2>/dev/null || echo "")
    
    if [ -n "${NEW_PRIMARY}" ] && [ "${NEW_PRIMARY}" != "${PRIMARY}" ]; then
        ELECTION_COMPLETE=true
        break
    fi
done

END_TIME=$(date +%s.%N)
FAILOVER_TIME=$(echo "${END_TIME} - ${START_TIME}" | bc)

if [ "${ELECTION_COMPLETE}" = true ]; then
    log "SUCCESS: New primary elected: ${NEW_PRIMARY}"
    log "Failover time: ${FAILOVER_TIME} seconds"
else
    log "FAILED: No new primary elected within ${TIMEOUT} seconds"
fi

# Restart the killed node
log "Restarting MongoDB on this node..."
systemctl start {{ mongodb_service_name }}

sleep 10

# Verify cluster health
log "Verifying cluster health..."
HEALTHY=$(mongosh --host localhost --port ${MONGO_PORT} ${AUTH_OPTS} \
    --eval "rs.status().members.every(m => m.health === 1)" \
    --quiet 2>/dev/null || echo "false")

if [ "${HEALTHY}" = "true" ]; then
    log "Cluster is healthy"
else
    log "WARNING: Some members may still be recovering"
fi

log ""
log "Test Results Summary"
log "===================="
log "Original Primary: ${PRIMARY}"
log "New Primary: ${NEW_PRIMARY:-N/A}"
log "Failover Time: ${FAILOVER_TIME} seconds"
log "Test Status: $([ "${ELECTION_COMPLETE}" = true ] && echo 'PASSED' || echo 'FAILED')"

# Save results in JSON format
cat > "${RESULTS_DIR}/kill-primary-latest.json" << EOF
{
    "test": "kill-primary",
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "original_primary": "${PRIMARY}",
    "new_primary": "${NEW_PRIMARY:-null}",
    "failover_time_seconds": ${FAILOVER_TIME},
    "status": "$([ "${ELECTION_COMPLETE}" = true ] && echo 'PASSED' || echo 'FAILED')"
}
EOF

exit $([ "${ELECTION_COMPLETE}" = true ] && echo 0 || echo 1)
