#!/bin/bash
# =============================================================================
# MongoDB Backup Cleanup Script
# =============================================================================
# Generated by Ansible - Do not edit manually
# =============================================================================

set -euo pipefail

BACKUP_DIR="{{ mongodb_backup_directory }}"
RETENTION_DAYS="{{ mongodb_backup_retention_days }}"
LOG_FILE="${BACKUP_DIR}/logs/cleanup_$(date +%Y%m%d).log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

log "Starting backup cleanup (retention: ${RETENTION_DAYS} days)"

# Find and delete old backups
OLD_BACKUPS=$(find "${BACKUP_DIR}" -name "mongodb_backup_*.tar.gz" -mtime +${RETENTION_DAYS} -type f 2>/dev/null || true)

if [ -n "${OLD_BACKUPS}" ]; then
    echo "${OLD_BACKUPS}" | while read -r backup; do
        log "Removing old backup: ${backup}"
        rm -f "${backup}"
        rm -f "${backup%.tar.gz}.sha256"
    done
else
    log "No old backups to remove"
fi

# Clean old logs (keep 30 days)
find "${BACKUP_DIR}/logs" -name "*.log" -mtime +30 -type f -delete 2>/dev/null || true

log "Cleanup completed"

# Display current backups
log "Current backups:"
ls -lh "${BACKUP_DIR}"/*.tar.gz 2>/dev/null | tee -a "${LOG_FILE}" || log "No backups found"

exit 0
